name: Update Qiita News Section

on:
  schedule:
    - cron: '0 0 * * *' # 毎日日本時間午前9時
  workflow_dispatch:     # 手動実行用

jobs:
  update-qiita:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install feedparser

      - name: Update HTML Content
        run: |
          python << END
          import feedparser
          import re
          import sys

          RSS_URL = "https://qiita.com/Necoze/feed"
          feed = feedparser.parse(RSS_URL)
          
          # 最新3件の記事カードを作成
          new_cards_html = ''
          for entry in feed.entries[:3]:
              date = entry.updated[:10].replace('-', '.')
              new_cards_html += f'''
              <a href="{entry.link}" class="card-link" target="_blank">
                  <article class="card">
                      <div class="card-img">QIITA ARTICLE</div>
                      <div class="card-content">
                          <div class="card-tag">Qiita / PRODUCT</div>
                          <h3 class="card-title">{entry.title}</h3>
                          <p class="card-update">Update: {date}</p>
                      </div>
                  </article>
              </a>'''

          # index.htmlを読み込み
          try:
              with open("index.html", "r", encoding="utf-8") as f:
                  html_content = f.read()
          except FileNotFoundError:
              print("index.htmlが見つかりません")
              sys.exit(1)

          # 置換用の正規表現パターン（コメントタグの間を特定）
          pattern = r".*?"
          
          # 置換後の文字列（タグを維持しつつ中身のgridを更新）
          replacement = f'\\n            <div class="grid">{new_cards_html}\\n            </div>\\n            '
          
          # タグが存在するか確認してから置換
          if "" in html_content:
              updated_html = re.sub(pattern, replacement, html_content, flags=re.DOTALL)
              with open("index.html", "w", encoding="utf-8") as f:
                  f.write(updated_html)
              print("Successfully updated Qiita section.")
          else:
              print("Error: が見つかりません。HTML側を確認してください。")
              sys.exit(1)
          END

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add index.html
          
          if ! git diff --cached --exit-code; then
            git commit -m "Automated Qiita News Update"
            git pull --rebase origin main
            git push origin main
          fi