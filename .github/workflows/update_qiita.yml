name: Update Qiita News Section

on:
  schedule:
    - cron: '0 0 * * *' # 毎日日本時間午前9時
  workflow_dispatch:     # 手動実行用

jobs:
  update-qiita:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install feedparser

      - name: Update HTML Content
        run: |
          python << END
          import feedparser
          import re

          RSS_URL = "https://qiita.com/Necoze/feed"
          feed = feedparser.parse(RSS_URL)
          
          new_cards_html = ''
          for entry in feed.entries[:3]:
              date = entry.updated[:10].replace('-', '.')
              new_cards_html += f'''
              <a href="{entry.link}" class="card-link" target="_blank">
                  <article class="card">
                      <div class="card-img">QIITA ARTICLE</div>
                      <div class="card-content">
                          <div class="card-tag">Qiita / PRODUCT</div>
                          <h3 class="card-title">{entry.title}</h3>
                          <p class="card-update">Update: {date}</p>
                      </div>
                  </article>
              </a>'''

          with open("index.html", "r", encoding="utf-8") as f:
              html_content = f.read()

          pattern = r".*?"
          replacement = f'\\n            <div class="grid">{new_cards_html}\\n            </div>\\n            '
          
          updated_html = re.sub(pattern, replacement, html_content, flags=re.DOTALL)

          with open("index.html", "w", encoding="utf-8") as f:
              f.write(updated_html)
          END

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 1. まず変更分をステージング
          git add index.html
          
          # 2. 変更がある場合のみ処理を継続
          if ! git diff --cached --exit-code; then
            # 3. ローカルで先にコミットを作る
            git commit -m "Automated Qiita News Update"
            
            # 4. リモートの最新を取り込みつつ、自分のコミットを上に乗せる
            # これで "unstaged changes" エラーを回避できます
            git pull --rebase origin main
            
            # 5. プッシュ
            git push origin main
          fi